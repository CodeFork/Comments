(function(){function e(){for(var u,r,i=document.getElementsByTagName("span"),n=0,f=i.length;n<f;n++)u=i[n],r=i[n].getAttribute("data-comments-url"),r!==null&&t.getCommentsCount(r,function(n){u.innerText=n})}function o(){var n=document.getElementById("comments-middleware");n!==null&&t.getView(function(t){n.innerHTML=t;ko.cleanNode(n);ko.applyBindings(new f,n)})}function r(n){n=n||!1;n||e();o()}var n={baseUrl:"/comments-middleware",commentMaxLength:600,includeHash:!1,includeQuery:!1,displayPostCommentOnLoad:!0},i=location.pathname,u,t,f;n.includeQuery&&(i+=location.search||"");n.includeHash&&(i+=location.hash||"");u=new function(){var n=this;n.get=function(n,t){var i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return i.open("GET",n),i.onreadystatechange=function(){i.readyState>3&&i.status>=200&&i.status<300&&t(i.responseText)},i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.send(),i};n.post=function(n,t,i){var r=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return r.open("POST",n),r.onreadystatechange=function(){r.readyState>3&&r.status>=200&&r.status<300&&i(r.responseText)},r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.send(t),r}};t=new function(t){var i=this;i.getCommentsCount=function(i,r){url=n.baseUrl+"/count?url="+encodeURIComponent(i);t.get(url,r)};i.getView=function(i){url=n.baseUrl+"/view.html";t.get(url,i)};i.preview=function(i,r){url=n.baseUrl+"/preview";t.post(url,i,r)};i.addComment=function(i,r){url=n.baseUrl+"/create";t.post(url,JSON.stringify(i),r)};i.loadComments=function(i,r){url=n.baseUrl+"/all-comments?url="+encodeURIComponent(i);t.get(url,r)};i.isAdmin=function(i){url=n.baseUrl+"/is-admin";t.get(url,function(n){var t=+n==1;i(t)})};i.approve=function(i,r,u){url=n.baseUrl+"/approve?approve="+r;t.post(url,i,u)};i.deleteComment=function(i,r){var u=JSON.stringify({StaticId:i,ReasonForDeleting:""});url=n.baseUrl+"/delete";t.post(url,u,r)}}(u);f=function(){var r=this,f,e,u,o;r.postCommentVisible=ko.observable(n.displayPostCommentOnLoad);r.loading=ko.observable(!1);r.previewVisible=ko.observable(!1);r.source=ko.observable("");r.rendered=ko.observable("");r.charsLeft=ko.observable(n.commentMaxLength);r.errors=ko.observableArray([]);r.useMarkdown=ko.observable(!1);r.errors=ko.observableArray([]);r.email=ko.observable("");r.name=ko.observable("");r.comments=ko.observableArray([]);r.isAdmin=ko.observable(!1);t.isAdmin(function(n){r.isAdmin(n)});r.useMarkdown.subscribe(function(){r.useMarkdown()||r.previewVisible(!1);r.errors.removeAll()});r.togglePostCommentVisible=function(){r.postCommentVisible(!r.postCommentVisible())};r.email.subscribe(function(){r.errors.removeAll()});r.name.subscribe(function(){r.errors.removeAll()});r.source.subscribe(function(){r.errors.removeAll();r.charsLeft(n.commentMaxLength-r.source().length)});f=function(n){var t=JSON.parse(n);t.ImgUrl="http://www.gravatar.com/avatar/"+t.PosterEmailHash+"?size=56&r=g";t.FormatedPostTime=new Date(t.PostTime.replace("T"," ")+" UTC").toLocaleString();t.updated=ko.observable(!1);r.comments.push(t);u();r.source("")};e=function(){var n={pageUrl:i,posterName:r.name(),posterEmail:r.email(),commentContentSource:r.source(),isMarkdown:r.useMarkdown()};t.addComment(n,f)};r.validateAndPost=function(){r.errors.removeAll();var t=function(n){return n.replace(/\s/g,"")},i=function(){t(r.name()).length===0&&r.errors.push("Name field is required.")},u=function(){t(r.email()).length===0?r.errors.push("Email field is required."):/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(r.email())||r.errors.push("Email is not in correct format.")},f=function(){t(r.source()).length===0?r.errors.push("Comment is required."):r.source().length>n.commentMaxLength&&r.errors.push("Your comment length exceeds allowed limit.")};i();u();f();r.errors().length===0&&e()};r.togglePreview=function(){var n=r.previewVisible();n?r.previewVisible(!1):(r.loading(!0),t.preview(r.source(),function(n){r.rendered(n);r.previewVisible(!0);r.loading(!1)}))};r.commentsCount=ko.observable("");u=function(){t.getCommentsCount(i,function(n){r.commentsCount(n)})};u();o=function(){t.loadComments(i,function(n){var t,i;for(r.comments([]),t=JSON.parse(n),i=0;i<t.length;i++)t[i].ImgUrl="http://www.gravatar.com/avatar/"+t[i].PosterEmailHash+"?size=56&r=g",t[i].FormatedPostTime=new Date(t[i].PostTime.replace("T"," ")+" UTC").toLocaleString(),t[i].updated=ko.observable(!1);r.comments(t)})};r.disapproveComment=function(n){t.approve(n.StaticId,!1,function(){n.updated(!0)})};r.approveComment=function(n){t.approve(n.StaticId,!0,function(){n.updated(!0)})};r.deleteComment=function(n){confirm("Are you sure you want to delete this comment?")&&t.deleteComment(n.StaticId,function(){n.updated(!0)})};o()};document.reloadCommentsMiddlewareViewModel=function(){r(!0)};document.readyState!=="loading"?r():document.addEventListener?document.addEventListener("DOMContentLoaded",r):document.attachEvent("onreadystatechange",function(){document.readyState==="complete"&&r()})})();